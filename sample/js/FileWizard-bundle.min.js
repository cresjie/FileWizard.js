/**
 * Plugin: FileWizard
 * Version: 1.1.0
 * Author: Cres Jie Labasano/**
 * Plugin: FileUploader
 * Author: Cres Jie Labasano
 * Email: cresjie@gmail.com
 * Github: http://github.com/cresjie
 * 
*/!function(e){e.FileUploader=function(e,t){var i=function(){},r={method:"post",error:i,complete:i,success:i,progress:i,data:{}},s={"Cache-Control":"no-cache","X-Requested-With":"XMLHttpRequest"};if(!(this instanceof FileUploader))return new FileUploader(e,t);FileUploader.extend(r,e),FileUploader.extend(s,t);var n=new XMLHttpRequest;if("get"==r.method.toLowerCase()){var a=Object.keys(r.data).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(r.data[e])}).join("&");n.open(r.method,r.url+"?"+a,!0)}else n.open(r.method,r.url,!0);for(var l in s)n.setRequestHeader(l,s[l]);return(!r.data||r.data&&r.data.constructor!=FormData)&&(r.data=FileUploader.toFormData(r.data)),n.onabort=r.abort,n.upload.onprogress=function(e){r.progress.call(this,e.loaded/e.total*100,e)},n.onreadystatechange=function(e){if(4===n.readyState){var t=n.responseText;if(n.getResponseHeader("content-type")&&n.getResponseHeader("content-type").indexOf("application/json")>-1)try{t=JSON.parse(t)}catch(i){e=i,t="Invalid JSON response from server."}200==n.status?r.success.call(this,t,e):r.error.call(this,t,e),r.complete.call(this,t,e)}},n.onerror=function(e,t){r.error.call(this,e,t)},n.send(r.data),this.abort=function(){return n.abort(),this},this.getRequest=function(){return n},this},FileUploader.toFormData=function(e,t){var i=new FormData;return e&&(e.constructor==Object?FileUploader.appendFormdata(i,e):i.append(e,t)),i},FileUploader.appendFormdata=function(e,t,i){if(i=i||"",!t||t.constructor!=Object&&t.constructor!=Array)e.append(i,null==t||void 0==t?"":t);else for(var r in t)""==i?FileUploader.appendFormdata(e,t[r],r):FileUploader.appendFormdata(e,t[r],i+"["+r+"]")},FileUploader.extend=function(e,t){for(var i in t)e[i]=t[i];return e}}(window),function(t){function i(e,t,r){return this.$element=$(e),this.settings=$.extend({},i.DEFAULTS,t),this.headers=$.extend({},i.HEADERS,r),this.files=[],this.queue=[],this._callbacks={},this.init(),this}function r(e,t){var r=[];if(arguments.length>1)for(var s in arguments)r.push(arguments[s]);var n=$(this),a=n.data("FileWizard");return a?a[e]?a[e].apply(a,r.splice(1,1)):void 0:(n.data("FileWizard",new i(n,e,t)),n)}var s=1,n=function(){};i.DEFAULTS={data:{},dragover:n,drop:n,dragenter:n,dragleave:n,rejected:function(e,t){switch(t){case"file_size":alert("File exceeds file size");break;case"file_type":alert("File type not allowed")}},complete:n,success:n,error:n,progress:n,paramName:"files",url:"",method:"POST",parallel_upload:!0,parallel_files:3,clickable:!0,draggable:!0,autoSend:!1,acceptedFiles:["jpg","jpeg","png","gif"],maxSize:5,multipleFiles:!0,file_limit:99},i.HEADERS={},i.sizeToMB=function(e){return e/1024/1024};var a={on:function(e,t){return this._callbacks[e]||(this._callbacks[e]=[]),this._callbacks[e].push(t),this},trigger:function(e){if(this._callbacks[e]){var t=Array.prototype.slice.call(arguments);t.shift(),this._callbacks[e].forEach(function(e){e.apply(this,t)})}return this},addData:function(e,t){return e&&(e.constructor==Object?$.extend(this.settings.data,e):this.settings.data[e]=t),this},getFiles:function(){return this.files},resetFiles:function(){var e=this.files.slice();return this.files=[],this.input.value=null,this.trigger("files_removed",e),this},addFiles:function(e){var t=this;loop=t.settings.multipleFiles?e.length:e.length?1:0,remaining=t.settings.file_limit-t.files.length,addedFiles=[],loop=remaining<loop?remaining:loop;for(var r=0;r<loop;r++){var s=t.settings.acceptedFiles;if(s.length){var n=e[r].name.split("."),a=n[n.length-1].toLowerCase();if(s.indexOf(a)<0)return t.settings.rejected.call(this,e[r],"file_type")}if(i.sizeToMB(e[r].size)>t.settings.maxSize)return t.settings.rejected.call(this,e[r],"file_size");t.settings.multipleFiles?t.files.push(e[r]):t.files[0]=e[r],addedFiles.push(e[r]),t.trigger("file_added",e[r])}return t.trigger("files_added",addedFiles),this},removeFile:function(e,t){if(t=t?t:1,e&&e.constructor==File&&(e=this.files.indexOf(e)),e>-1){var i=this.files.splice(e,t);this.trigger("files_removed",i)}return this},setOptions:function(e){return $.extend(this.settings,e),this},send:function(){this.addData.apply(this,arguments);var e=this,t=$.extend({},e.settings),i=e.files.slice(0),r=e.settings.progress;if(successFn=e.settings.success,completeFn=e.settings.complete,errorFn=e.settings.error,t.parallel_upload)for(var s=function(){if(i.length){var n=i.shift(),a=null;t.data[e.settings.paramName]=n,t.complete=function(t,i){completeFn.call(e,t,i,n),e.removeQueue(a),s()},t.success=function(t,r){successFn.call(e,t,r,n);var s=i.indexOf(n);s>-1&&i.slice(s,1)},t.error=function(e,t){errorFn.call(this,e,t,n)},t.progress=function(t,i){r.call(this,t,i,n,e,a)},e.trigger("before_submit",t,n),a=new FileUploader(t,e.headers),e.addQueue(a),e.trigger("submitted",t,n)}else delete t.data[t.paramName]},n=e.settings.parallel_files>this.queue.length?e.settings.parallel_files-this.queue.length:0,a=0;n>a;a++)s();else{var l=null;for(var a in i)t.data[t.paramName]=i.length>1?i:i[a];t.complete=function(i,r){completeFn.call(e,i,r),e.removeQueue(l),delete t.data[t.paramName]},e.trigger("before_submit",t,i),l=new FileUploader(t,e.headers),e.trigger("submitted",t,i)}return this},abort:function(e){e=e?e:0;var t=this.queue[0];return t&&(t.abort(),this.queue.splice(e,1)),this},abortAll:function(){return this.queue.forEach(function(e){e.abort()}),this.queue=[],this},addQueue:function(e){return this.queue.push(e),this},removeQueue:function(e){var t=this.queue.indexOf(e);return t>-1&&this.queue.splice(t,1),this},init:function(){var t=this;return this.$element.each(function(i,r){t.settings.draggable&&$(r).on({dragenter:function(e){e.originalEvent.dataTransfer.types.indexOf("Files")>-1&&($(this).addClass("filewizard-dragenter"),t.settings.dragenter.call(this,e))},dragleave:function(e){$(this).removeClass("filewizard-dragenter filewizard-dragover"),t.settings.dragleave.call(this,e)},dragover:function(e){e.preventDefault(),$(this).addClass("filewizard-dragover"),t.settings.dragover.call(this,e)},drop:function(i){e=i.originalEvent,e.stopPropagation(),e.preventDefault(),$(this).removeClass("filewizard-dragenter filewizard-dragover"),e.dataTransfer.types.indexOf("Files")>-1?(files=e.dataTransfer.files,t.settings.drop.call(this,e,files),t.addFiles(files)):t.settings.rejected.call(this,null,"not_file",e),this.value=""}})}),t.settings.clickable&&this.initForm(),this},initForm:function(){var e=this;e.input=document.createElement("input"),$(e.input).attr({type:"file",multiple:e.settings.multipleFiles,"class":"filewizard-input filewizard-input-"+s}).css("display","none").on("change",function(t){e.addFiles(this.files),this.value=""}),this.$element.on("click",function(t){t.preventDefault(),$(e.input).trigger("click")}),$("body").append(e.input),s++},getOptions:function(){return this.settings}};$.extend(i.prototype,a),$.fn.FileWizard=r,$.fn.FileWizard.Constructor=i,t.FileWizard=i}(window);